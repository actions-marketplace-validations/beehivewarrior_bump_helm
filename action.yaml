name: 'Bump Chart Version'
description: 'Automatically Bump Helm Chart Version'
inputs:
  chart_name:
    description: 'Chart to be bumped'
    required: true
  bump_strategy:
    description: 'How the chart should be bumped'
    required: false
    default: 'PATCH'

runs:
  using: composite
  steps:
    - uses: actions/checkout@v3
    - name: "Run Point"
      env:
        BUMP_STRATEGY: ${{ inputs.bump_strategy }}
        CHART_NAME: ${{ inputs.chart_name }}
      shell: bash
      run: |
        entrypoint="import sys;
        import subprocess;
        from pathlib import Path;
        MAIN_SCRIPT = Path(r'${GITHUB_ACTION_PATH}') / 'auto_bump' / 'main.py';
        proc = subprocess.run([sys.executable, str(MAIN_SCRIPT)]);
        sys.exit(proc.returncode)
        "
        if [ "$RUNNER_OS" == "Windows" ]; then
          echo $entrypoint | python
        else
          echo $entrypoint | python3
        fi
    - name: "Check Usage"
      env:
        BUMP_STRATEGY: ${{ inputs.bump_strategy }}
        FIRST_MATE_MESSAGE: |
          cat << EOF
          Bumped Helm Chart Version From "$FIRST_MATE_OLD_VERSION" to "$FIRST_MATE_NEW_VERSION"
          
          Changes committed by ${{ github.actor }} in commit: ${{ github.event.after }} altered the Helm Chart.
          I updated the Chart.yaml file using the "BUMP_STRATEGY" strategy.
          
          Signed-off-by: firstmate[bot] <bot@firstmate.dev>
          EOF

      run: |
        if [[`git status --porcelain` ]]; then
          git config --local user.name "first-mate-bot"
          git config --local user.email "bot@firstmate.dev"
          git add -A
          git commit -m "$FIRST_MATE_MESSAGE"

      shell: bash